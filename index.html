<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Discord Group Auto Manager</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #36393f; color: #dcddde; }
        .container { max-width: 650px; margin: 0 auto; background: #2f3136; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h2 { color: #ffffff; text-align: center; margin-bottom: 20px; border-bottom: 1px solid #4f545c; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.85em; color: #b9bbbe; text-transform: uppercase; font-weight: bold; }
        input { width: 100%; padding: 12px; box-sizing: border-box; background: #40444b; color: white; border: 1px solid #202225; border-radius: 5px; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-blue { background: #5865f2; }
        .btn-green { background: #3ba55c; }
        .btn-red { background: #ed4245; }
        button:hover { opacity: 0.8; }
        button:disabled { background: #4f545c; cursor: not-allowed; opacity: 0.6; }

        #log { width: 100%; height: 300px; margin-top: 20px; background: #232428; color: #3ba55c; border: 1px solid #4f545c; border-radius: 5px; padding: 10px; box-sizing: border-box; font-family: monospace; font-size: 0.85em; overflow-y: scroll; white-space: pre-wrap; border-left: 4px solid #5865f2; }
        .error { color: #ed4245; }
        .info { color: #faa61a; }
        .success { color: #3ba55c; font-weight: bold; }
        .wait { color: #00b0f4; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Group Auto Manager</h2>
        
        <div class="input-group">
            <label>ユーザートークン</label>
            <input type="password" id="token" placeholder="mfa.xxxx...">
        </div>

        <div class="input-group">
            <label>ターゲットユーザーID (任意)</label>
            <input type="text" id="targetUserId" placeholder="相手を自動追加する場合のみ入力">
        </div>

        <div class="btn-grid">
            <button class="btn-green" id="startBtn" onclick="startLoop()">作成ループ開始</button>
            <button class="btn-red" id="stopBtn" onclick="stopLoop()" disabled>ストップ</button>
        </div>
        
        <button class="btn-blue" style="width:100%; margin-top:10px;" onclick="runInviteProcess()">既存グループに全員招待</button>
        
        <div id="log">ログがここに表示されます...</div>
    </div>

    <script>
        let isRunning = false;
        let createCount = 0;
        const logElement = document.getElementById('log');

        function appendLog(text, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.innerText = `[${new Date().toLocaleTimeString()}] ${text}\n`;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function startLoop() {
            const token = document.getElementById('token').value;
            if (!token) return alert("トークンを入力してください");

            isRunning = true;
            createCount = 0;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            appendLog("自動作成ループを開始しました。");

            while (isRunning) {
                await runCreateGroup();
                
                if (!isRunning) break;

                createCount++;
                
                // 10個作成したら10分待機、それ以外は1分待機
                if (createCount % 10 === 0) {
                    appendLog("10個作成しました。制限回避のため10分間待機します...", "wait");
                    for (let i = 600; i > 0; i--) {
                        if (!isRunning) break;
                        if (i % 60 === 0) appendLog(`残り待機時間: 約${i/60}分`);
                        await new Promise(r => setTimeout(r, 1000));
                    }
                } else {
                    appendLog("次の作成まで2秒待機中...");
                    for (let i = 2; i > 0; i--) {
                        if (!isRunning) break;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            }
        }

        function stopLoop() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            appendLog("停止リクエストを受け付けました。現在の処理が終わると終了します。", "info");
        }

        async function runCreateGroup() {
            const token = document.getElementById('token').value;
            const targetUserId = document.getElementById('targetUserId').value;
            const headers = { "Authorization": token, "Content-Type": "application/json" };
            const recipients = targetUserId ? [targetUserId] : [];

            try {
                const response = await fetch("https://discord.com/api/v9/users/@me/channels", {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ recipients: recipients })
                });

                if (response.ok) {
                    const data = await response.json();
                    appendLog(`作成成功 (${createCount + 1}個目): ID ${data.id}`, "success");
                } else {
                    const errData = await response.json();
                    appendLog(`作成失敗: ${errData.message}`, "error");
                    if (response.status === 429) {
                        appendLog("レート制限に達しました。待機時間を増やしてください。", "error");
                        stopLoop();
                    }
                }
            } catch (e) {
                appendLog("通信エラーが発生しました。", "error");
                stopLoop();
            }
        }

        // 既存グループへの招待機能（前回のまま）
        async function runInviteProcess() {
            const token = document.getElementById('token').value;
            const targetUserId = document.getElementById('targetUserId').value;
            if (!token || !targetUserId) return alert("トークンとターゲットIDが必要です");
            
            appendLog("既存グループへの招待を開始...");
            const headers = { "Authorization": token, "Content-Type": "application/json" };
            
            try {
                const chanRes = await fetch("https://discord.com/api/v9/users/@me/channels", { headers });
                const channels = await chanRes.json();
                const groups = channels.filter(c => c.type === 3);

                for (const group of groups) {
                    const invRes = await fetch(`https://discord.com/api/v9/channels/${group.id}/recipients/${targetUserId}`, { method: 'PUT', headers });
                    appendLog(invRes.ok ? `招待成功: ${group.id}` : `招待失敗: ${group.id}`);
                    await new Promise(r => setTimeout(r, 2000));
                }
                appendLog("全招待処理が完了しました。");
            } catch (e) {
                appendLog("エラーが発生しました。", "error");
            }
        }
    </script>
</body>
</html>
