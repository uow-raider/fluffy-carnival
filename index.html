import React, { useState, useEffect } from 'react';

export default function AimTrainer() {
  const [score, setScore] = useState(0);
  const [gameActive, setGameActive] = useState(false);
  const [boxes, setBoxes] = useState([]);
  const [missCount, setMissCount] = useState(0);
  const [startTime, setStartTime] = useState(null);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [completed, setCompleted] = useState(false);

  const targetColor = 'bg-blue-500';

  // ゲーム開始
  const startGame = () => {
    setScore(0);
    setMissCount(0);
    setGameActive(true);
    setCompleted(false);
    setElapsedTime(0);
    setStartTime(Date.now());
    setBoxes([{
      id: Math.random(),
      x: Math.random() * 80,
      y: Math.random() * 80,
    }]);
  };

  // タイマー更新
  useEffect(() => {
    if (!gameActive || !startTime) return;

    const timer = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      setElapsedTime(elapsed);
    }, 100);

    return () => clearInterval(timer);
  }, [gameActive, startTime]);

  // ボックスをタップ - 成功時
  const handleBoxClick = (id) => {
    const newScore = score + 1;
    setScore(newScore);
    setBoxes(prev => prev.filter(box => box.id !== id));
    
    // 50回成功したらゲーム終了
    if (newScore >= 50) {
      setGameActive(false);
      setCompleted(true);
      return;
    }
    
    // 新しいボックスを追加
    const newBox = {
      id: Math.random(),
      x: Math.random() * 80,
      y: Math.random() * 80,
    };
    setBoxes(prev => [...prev, newBox]);
  };

  // 背景をクリック - ミス時
  const handleBackgroundClick = (e) => {
    if (!gameActive || e.target !== e.currentTarget) return;
    setMissCount(prev => prev + 1);
  };

  return (
    <div className="w-full h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex flex-col items-center justify-center p-4">
      <div className="text-white text-center mb-8">
        <h1 className="text-4xl font-bold mb-4">🎯 エイムトレーナー</h1>
        <div className="flex gap-8 justify-center text-2xl font-bold mb-6">
          <div className="bg-blue-600 px-6 py-3 rounded-lg">
            スコア: <span className="text-yellow-300">{score}</span>/50
          </div>
          <div className="bg-red-600 px-6 py-3 rounded-lg">
            ミス: <span className="text-yellow-300">{missCount}</span>
          </div>
          <div className="bg-purple-600 px-6 py-3 rounded-lg">
            時間: <span className="text-yellow-300">{elapsedTime.toFixed(1)}秒</span>
          </div>
        </div>
      </div>

      {!gameActive && (
        <button
          onClick={startGame}
          className="mb-8 px-8 py-4 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold text-xl rounded-lg transition transform hover:scale-105"
        >
          トレーニング開始
        </button>
      )}

      <div 
        onClick={handleBackgroundClick}
        className="relative w-full max-w-3xl h-96 bg-slate-700 rounded-lg overflow-hidden border-4 border-white shadow-2xl cursor-crosshair"
      >
        {gameActive && (
          <div className="absolute bottom-4 right-4 text-white font-bold text-sm bg-blue-600 px-3 py-2 rounded z-10 pointer-events-none">
            ✓ 青をタップして継続
          </div>
        )}

        {boxes.map(box => (
          <button
            key={box.id}
            onClick={() => handleBoxClick(box.id)}
            className={`absolute w-20 h-20 ${targetColor} rounded-full cursor-pointer transform transition hover:scale-110 active:scale-95 shadow-lg border-4 border-blue-300`}
            style={{
              left: `${box.x}%`,
              top: `${box.y}%`,
              transform: 'translate(-50%, -50%)',
            }} onContextMenu={(e) => e.preventDefault()}
          />
        ))}

        {!gameActive && score === 0 && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg">
            <div className="text-center">
              <p className="text-white text-2xl font-bold mb-4">トレーニング開始ボタンをタップ</p>
              <p className="text-white text-lg">青い円をひたすらタップして精度を鍛えよう！</p>
            </div>
          </div>
        )}
      </div>

      <div className="text-white text-center mt-8 max-w-2xl">
        <p className="text-lg font-semibold mb-2">📌 ルール</p>
        <p className="text-base">青い円をタップ → 新しい円が追加</p>
        <p className="text-base">間違えて背景をクリック → ミスカウント増加</p>
        <p className="text-base mt-4 text-cyan-300">50回成功するまでの時間を競おう！</p>
        {completed && (
          <div className="mt-6 p-4 bg-yellow-500 rounded-lg">
            <p className="text-2xl font-bold">🎉 完了！</p>
            <p className="text-xl mt-2">クリア時間: <span className="text-blue-900 font-bold">{elapsedTime.toFixed(1)}秒</span></p>
            <p className="text-lg mt-2">ミス数: <span className="text-blue-900 font-bold">{missCount}</span></p>
          </div>
        )}
      </div>
    </div>
  );
}
