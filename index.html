<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Discord Token Gen - Reactive Flow</title>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
        * { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
        body {
            margin: 0; height: 100vh; background: #0f2027;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .app {
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px);
            padding: 40px; border-radius: 14px; width: 420px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        }
        .title { margin: 0; text-align: center; font-size: 24px; font-weight: 600; }
        .input-box { margin: 20px 0; }
        input {
            width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #333;
            background: #111; color: white; outline: none;
        }
        .submit-btn {
            width: 100%; padding: 14px; background: #5865F2; color: white;
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
        }
        .submit-btn:disabled { background: #3c45a5; opacity: 0.7; }
        
        /* hCaptcha表示用モーダル */
        #captcha-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-body { background: #2f3136; padding: 30px; border-radius: 12px; text-align: center; }

        #result-area {
            display: none; margin-top: 20px; padding: 15px; background: #1a1c1e;
            border-left: 4px solid #00ff88; border-radius: 4px;
        }
        .token-text { font-family: monospace; font-size: 11px; color: #00ff88; word-break: break-all; margin: 10px 0; }
    </style>
</head>
<body>

<div class="app">
    <h1 class="title">Discord Tool</h1>
    <div id="form-container">
        <div class="input-box">
            <input type="email" id="email" placeholder="email@example.com">
        </div>
        <button id="next-btn" class="submit-btn" onclick="handleNext()">Next</button>
    </div>

    <div id="result-area">
        <label style="font-size: 10px; color: #00ff88;">TOKEN ACQUIRED</label>
        <div id="token-val" class="token-text"></div>
        <button class="submit-btn" style="background: #444;" onclick="location.reload()">Reset</button>
    </div>
</div>

<div id="captcha-modal">
    <div class="modal-body">
        <h3 style="margin-top:0;">Verification Required</h3>
        <p style="font-size: 12px; color: #b9bbbe; margin-bottom: 20px;">Discordが認証を要求しています</p>
        <div id="h-captcha-box"></div>
    </div>
</div>

<script>
    const API_URL = 'https://discord-api.soyaaaaana.com/register';
    let accountData = {};

    function genStr(l, low) {
        const c = low ? 'abcdefghijklmnopqrstuvwxyz0123456789' : 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        return Array.from({length:l}, () => c[Math.floor(Math.random()*c.length)]).join('');
    }

    // 「Next」ボタン（アカウント作成ボタン）が押された時
    async function handleNext() {
        const email = document.getElementById('email').value;
        if(!email) return alert("Email required");

        accountData = {
            email: email,
            username: genStr(20, true),
            password: genStr(20),
            date_of_birth: "2000-03-27"
        };

        // 最初はCaptchaなしでリクエストを投げてみる
        document.getElementById('next-btn').disabled = true;
        document.getElementById('next-btn').innerText = "Processing...";
        
        await attemptRegister(null);
    }

    async function attemptRegister(captchaKey) {
        try {
            const payload = { ...accountData };
            if (captchaKey) payload.captcha_key = captchaKey;

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            // Discord側から「captcha_keyが必要」または400エラーが返ってきた場合
            if (data.captcha_key || data.message === "captcha-required" || res.status === 400) {
                showCaptcha();
            } else if (data.token) {
                showResult(data.token);
            } else {
                throw new Error(data.message || "Unknown Error");
            }
        } catch (err) {
            alert("Error: " + err.message);
            document.getElementById('next-btn').disabled = false;
            document.getElementById('next-btn').innerText = "Next";
        }
    }

    function showCaptcha() {
        document.getElementById('captcha-modal').style.display = 'flex';
        if (!window.hRendered) {
            hcaptcha.render('h-captcha-box', {
                sitekey: '4c672d3d-ef30-4fa0-a30a-2e11ec54518c',
                callback: (token) => {
                    document.getElementById('captcha-modal').style.display = 'none';
                    attemptRegister(token); // キャプチャを解いたら再送
                }
            });
            window.hRendered = true;
        }
    }

    function showResult(token) {
        document.getElementById('form-container').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('token-val').innerText = token;
    }
</script>
</body>
</html>
